import React, { useRef, useState, useEffect } from 'react'
import Blockly from './blocks.js'
import { getSingleQuestion } from './BlockAPI.js';

/// ë¸”ë¡ ë°°ì¹˜ ê²Œì„
/// Blockly API ì‚¬ìš©

// block.jsì— ë“±ë¡í•œ ì»¤ìŠ¤í…€ ë¸”ë¡ì„ ë§¤í•‘
const toolbox = {
    "kind": "flyoutToolbox",
    "contents": [
        { "kind": "block", "type": "try_block" },
        { "kind": "block", "type": "catch_arithmetic" },
        { "kind": "block", "type": "catch_arrayindex" },
        { "kind": "block", "type": "catch_numberformat" },
        { "kind": "block", "type": "catch_exception" },
        { "kind": "block", "type": "finally_block" },
        { "kind": "block", "type": "print_statement" },
        { "kind": "block", "type": "divide_statement" }
    ]
};

// ì´ˆê¸° í™”ë©´ì— ë³´ì—¬ì¤„ ë¬¸ì œ
// DBì—°ê²°í•˜ë©´ ì—†ì•¨ê±°ì„
const initialWorkspaceXml = `
<xml xmlns="https://developers.google.com/blockly/xml">
  <block type="try_block" x="40" y="40">
    <statement name="TRY_BODY">
      <block type="print_statement">
        <field name="PRINT_TEXT">a / b</field>
      </block>
    </statement>
    <next>
      <!-- catch ë¸”ë¡ì„ ì—¬ê¸°ì— ë°°ì¹˜í•´ì•¼ ì •ë‹µ -->
      <next>
        <block type="finally_block">
          <statement name="FINALLY_BODY">
            <block type="print_statement">
              <field name="PRINT_TEXT">ì¶œë ¥5</field>
            </block>
          </statement>
        </block>
      </next>
    </next>
  </block>
</xml>
`;

// ì •ë‹µ ì²´í¬ ë©”ì†Œë“œ
// í˜„ì¬ëŠ” í•˜ë“œì½”ë”© ë˜ì–´ ìˆì§€ë§Œ DBì—°ê²° í›„ ë³€ìˆ˜í™” ì˜ˆì •
function isCorrect(workspace) {
    // workspaceì˜ ëª¨ë“  ë¸”ë¡ íƒìƒ‰í•´ì„œ catch_arithmetic ë¸”ë¡ì´ ìˆëŠ”ì§€ ê²€ì‚¬   // ìƒë‹¨ì— ë§¤í•‘í•œ typeìœ¼ë¡œ ê²€ì‚¬
    const allBlocks = workspace.getAllBlocks(false);
    // ë°˜ë“œì‹œ catch_arithmetic ë¸”ë¡ì´ 1ê°œ ì´ìƒ ìˆì–´ì•¼ ì •ë‹µ
    return allBlocks.some(block => block.type === "catch_arithmetic");
}


const BlockMain = () => {
    const blocklyDiv = useRef(null);
    const workspaceRef = useRef(null);
    const [result, setResult] = useState("");

    useEffect(() => {
        workspaceRef.current = Blockly.inject(blocklyDiv.current, {
            toolbox,
            trashcan: true,
            scrollbars: true
        });

        // ë¬¸ì œ ì´ˆê¸° ë¸”ë¡ ë°°ì¹˜
        const xml = Blockly.utils.xml.textToDom(initialWorkspaceXml);
        workspaceRef.current.clear();
        Blockly.Xml.appendDomToWorkspace(xml, workspaceRef.current);

        return () => {
            workspaceRef.current && workspaceRef.current.dispose();
        };
    }, []);

    const handleCheck = () => {
        if (isCorrect(workspaceRef.current)) {
            setResult("ì •ë‹µì…ë‹ˆë‹¤! ğŸ‰");
        } else {
            setResult("ì˜¤ë‹µì…ë‹ˆë‹¤. ğŸ˜¢");
        }
    };

    const showData = async(qid) => {
        console.log(await getSingleQuestion(qid));
    }

    showData(1);

    return (
        <div>
            <h2>ì˜ˆì™¸ ì²˜ë¦¬ ë¸”ë¡ í€´ì¦ˆ</h2>
            <p>
                <b>
                    aë¥¼ bë¡œ ë‚˜ëˆ„ëŠ” ì½”ë“œì—ì„œ <br />
                    0ìœ¼ë¡œ ë‚˜ëˆŒ ë•Œ ë°œìƒí•˜ëŠ” ì˜ˆì™¸ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì²˜ë¦¬í•˜ëŠ” <br />
                    catch ë¸”ë¡ì„ ì•„ë˜ì— ëŒì–´ë‹¤ ë†“ìœ¼ì„¸ìš”.
                </b>
            </p>
            <div ref={blocklyDiv} style={{
                height: "500px",
                width: "1200px",
                background: "#f7f7f7",
                margin: "0 auto",
                borderRadius: "12px",
                boxShadow: "0 2px 12px rgba(0,0,0,0.05)"
            }} />
            <button onClick={handleCheck} style={{ marginTop: 16 }}>ì •ë‹µ í™•ì¸</button>
            <div style={{ marginTop: 16, fontWeight: "bold" }}>{result}</div>
        </div>
    )
}

export default BlockMain
