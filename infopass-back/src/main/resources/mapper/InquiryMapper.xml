<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="boot.infopass.mapper.InquiryMapper">

    <resultMap id="inquiryMap" type="boot.infopass.dto.InquiryDto">
        <id property="id" column="id" />
        <result property="user_id" column="user_id" />
        <result property="title" column="title" />
        <result property="category" column="category" />
        <result property="content" column="content" />
        <result property="status" column="status" />
        <result property="created_at" column="created_at" />
        <result property="updated_at" column="updated_at" />
        <result property="response_content" column="response_content" />
        <result property="response_date" column="response_date" />
        <result property="user_name" column="user_name" />
        <result property="user_email" column="user_email" />
    </resultMap>

    <!-- 목록 조회 (검색/정렬/페이징) -->
    <select id="findInquiries" resultMap="inquiryMap">
        SELECT i.*, u.name AS user_name, u.email AS user_email
        FROM inquiries i
        LEFT JOIN user u ON u.id = i.user_id
        <where>
            <if test="q != null and q != ''">
                (i.title LIKE CONCAT('%', #{q}, '%') OR i.content LIKE CONCAT('%', #{q}, '%'))
            </if>
            <if test="category != null and category != ''">
                AND i.category = #{category}
            </if>
            <if test="userName != null and userName != ''">
                AND u.name LIKE CONCAT('%', #{userName}, '%')
            </if>
        </where>
        ORDER BY
        <choose>
            <when test="sort != null and sort != ''">
                ${sort} ${order}
            </when>
            <otherwise>
                i.created_at DESC
            </otherwise>
        </choose>
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countInquiries" resultType="int">
        SELECT COUNT(*)
        FROM inquiries i
        LEFT JOIN user u ON u.id = i.user_id
        <where>
            <if test="q != null and q != ''">
                (i.title LIKE CONCAT('%', #{q}, '%') OR i.content LIKE CONCAT('%', #{q}, '%'))
            </if>
            <if test="category != null and category != ''">
                AND i.category = #{category}
            </if>
            <if test="userName != null and userName != ''">
                AND u.name LIKE CONCAT('%', #{userName}, '%')
            </if>
        </where>
    </select>

    <select id="getById" parameterType="int" resultMap="inquiryMap">
        SELECT i.*, u.name AS user_name, u.email AS user_email
        FROM inquiries i LEFT JOIN user u ON u.id = i.user_id
        WHERE i.id = #{id}
    </select>

    <update id="updateStatus">
        UPDATE inquiries SET status = #{status}, updated_at = NOW()
        WHERE id = #{id}
    </update>

    <update id="updateReply">
        UPDATE inquiries 
        SET response_content = #{response_content}, response_date = NOW(), status = '답변 완료', updated_at = NOW()
        WHERE id = #{id}
    </update>

    <!-- 사용자용: 문의 등록 -->
    <insert id="insertInquiry" parameterType="boot.infopass.dto.InquiryDto" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO inquiries (
            user_id, title, category, content, status, created_at, updated_at
        ) VALUES (
            #{user_id}, #{title}, #{category}, #{content}, '접수', NOW(), NOW()
        )
    </insert>

    <!-- 사용자용: 내 문의 목록 -->
    <select id="selectInquiriesByUserId" parameterType="int" resultMap="inquiryMap">
        SELECT i.*, u.name AS user_name, u.email AS user_email
        FROM inquiries i LEFT JOIN user u ON u.id = i.user_id
        WHERE i.user_id = #{userId}
        ORDER BY i.created_at DESC
    </select>

</mapper>